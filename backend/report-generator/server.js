"use strict";function server(e,t){console.log("Request for ->"+e.url),t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET,POST,PUT,DELETE,OPTIONS"),t.setHeader("Access-Control-Allow-Headers","Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With");var r="";e.on("data",function(e){r+=e}),e.on("end",function(o){if("application/fox-pro"===e.headers["content-type"]){r=r.replace(/\n|\r|\t/g,"");var a=JSON.parse(r);return validateFormat(a.exportar)?toJson.fromObjectXML(a).then(function(e){return makeReport(e.data,e.vars,e.email,a.exportar,t,!0)})["catch"](console.log.bind(console)):t.end("Formato no soportado")}var n=JSON.parse(r);validate.validateParams(n).then(function(e){if(e)return t.end(t.writeHead(400,e));var r=validate.prepareReportParams(n);makeReport(r.fullData,r.fullVars,n.plantilla,n.email,n.exportar,t)})})}function sendEmail(e,t){email.sendMail({to:e.para,subject:e.asunto,text:e.texto,attachments:t})}function makeReport(e,t,r,o,a,n,i){report(e,t,r,a).then(function(e){var t="reporte."+a;if(o){var r=path.join(tempFolder,"output."+a),s=[{filename:t,content:fs.createReadStream(r)}];sendEmail(o,s)}return i?file.write(path.join(tempFolder,t),e).then(function(e){return n.end(e)})["catch"](console.log.bind(console)):("pdf"===a&&(n.setHeader("Content-type","application/pdf"),e.pipe(n)),"csv"===a&&(n.setHeader("Content-type","text/csv"),n.end(e)),"docx"===a&&(n.setHeader("Content-type","application/msword"),e.pipe(n)),void("txt"===a&&(n.setHeader("Content-type","text/plain"),n.end(e))))})}var http=require("http"),config=require("./config"),report=require("./report"),queryString=require("query-string"),email=require("./email")(),toJson=require("./toJson"),fs=require("fs"),path=require("path"),file=require("./File"),validate=require("./validate"),tempFolder=path.join(__dirname,"temp");http.createServer(server).listen(config.servicePort),console.log("Escuchando "+config.servicePort);