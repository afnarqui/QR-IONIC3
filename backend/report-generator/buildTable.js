"use strict";function main(t,e,r,a,n){var o=n,u={};r&&(u=groupByData(e[0],r),e=u.totalData.map(function(t){return t.data}));var l=buildTables(e,t,a,r);return l.promisesArray.reduce(function(t,e){return t.then(e)}).then(function(){return o=r?putTablesGroupBy(l.data,u,r,o,t):putTables(l.data,o),"html"===t?htmlSemantic(o):o})}function htmlSemantic(t){return"<head>"+styles+"<meta-charset='UTF-8'></head><body>"+t+"</body>"}function groupByData(t,e){var r=[],a=[t[0]],n=t.length-1,o=arrayToObject(e),u=1;return 0===n?{totalData:[{data:a,totalPerProperty:{}}],dataCount:u}:(t.reduce(function(t,l,i){u++;var s=e.filter(function(e){return t[e]!==l[e]});return s.length?(r.push({data:a,footer:e.slice(e.indexOf(s[0])),totalPerProperty:columnCounter(o,s,a.length)}),a=[l]):a.push(l),n===i&&(s.length?r.push({data:[l],footer:e.slice(e.indexOf(s[0])),totalPerProperty:columnCounter(o,e,a.length)}):r.push({data:a,footer:e.slice(e.indexOf(s[0])),totalPerProperty:columnCounter(o,e,a.length)})),l}),{totalData:r,dataCount:u})}function columnCounter(t,e,r){return t=sumAll(t,r),e.reduce(function(e,r){return e[r]=t[r],t[r]=0,e},{})}function sumAll(t,e){for(var r=Object.keys(t),a=0,n=r.length;a<n;a++)t[r[a]]+=e;return t}function buildTables(t,e,r,a){var n=[],o=[];t=_setData(t,a);for(var u=0,l=t.length;u<l;u++)t[u]&&o.push(formats[e](t[u],r).then(function(t){return n.push(t)}));return{data:n,promisesArray:o}}function putTables(t,e){if(e&&t)for(var r=0,a=t.length;r<a;r++){var n=e.replace("#DATAREPORTE#",t[r]);e=n.replace(/null/g,"")}return e}function putTablesGroupBy(t,e,r,a,n){var o=e.totalData;a+=snipets[n].fillFooter(o[0].data[0],r);for(var u=0,l=t.length-1;u<=l;u++)a+=snipets[n].newLine(2)+t[u],a+=snipets[n].fillTotales(o[u].totalPerProperty,o[u].data[0]),u!==l&&(a+=snipets[n].newLine(2)+snipets[n].fillFooter(o[u+1].data[0],o[u].footer));return a+=snipets[n].newLine(2)+snipets[n].fillFooter({"Total Registros":e.dataCount},["Total Registros"])}function _setData(t,e){var r=["id","nro","pages"],a=[];e&&e.length>0&&(r=r.concat(e));for(var n=0;n<t.length;n++){var o=t[n];if(void 0!==o){var u=[],l=[];for(var i in o){var s={};for(var c in o[i])if(c.search("_")>=0&&u.push(c.replace("_ValorCampo","")),r.indexOf(c)==-1&&u.indexOf(c)==-1){var f=c;s[f.replace("_ValorCampo","")]=o[i][c]}l.push(s)}a.push(l)}}return a.push(void 0),a}function arrayToObject(t){return t.reduce(function(t,e){return t[e]=0,t},{})}var styles=require("./styles.js"),snipets=require("./snipets"),formats={html:require("./buildHtmlTable"),txt:require("./buildTxtTable").toTxt,csv:require("./toXls")};module.exports=main;